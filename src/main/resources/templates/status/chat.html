<html layout:decorate="~{layout/layout.html}" xmlns:layout="http://www.w3.org/1999/xhtml">

<body>

<header layout:fragment="header" class="sticky top-0">
    <div class="navbar max-w-2xl mx-auto bg-base-100">
        <div class="navbar-start">
            <button>
                <i class="fas fa-thin fa-arrow-left fa-2xl ml-1"></i>
            </button>
        </div>
        <div class="navbar-center">
        <span class="text-2xl">
          투표 및 현황
        </span>
        </div>
        <div class="navbar-end">
            <button>마감하기</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"
            integrity="sha512-iKDtgDyTHjAitUDdLljGhenhPwrbBfqTKWO1mkhSFH3A7blITC9MhYon6SjnMhp4o0rADGw9yAC6EW4t5a4K3g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- date-fns -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script>

    <script>
        /*<![CDATA[*/
        let roomId = [[${roomId}]];
        let memberId = [[${@memberRepository.findByName(#authentication.principal.name).get().id}]];
        /*]]>*/

        let stompClient = null;

        let curSlice;
    </script>
</header>

<main layout:fragment="main" class="flex-grow flex items-center justify-center">
    <div class="max-w-2xl w-full bg-blue-50">
        <div class="text">
            <div class="title">모임이름</div>
            <div class="font-gsans w-56 flex justify-center text-2xl">서울 벙개</div>
        </div>

        <div class="chat-box flex flex-col mx-12 pt-2.5">
            <div id="chats" class="overflow-auto h-72">
                <!-- 채팅내용 -->
            </div>
            <div class="flex-grow"></div>
            <div class="chat-input p-2.5">
                <form>
                    <input required type="text" class="p-1 font-gsans" id="content" placeholder=" 내용 입력 후 Enter"/>
                    <button type="submit" id="send">입력</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(async () => {
            connect();
            $('form').on('submit', e => e.preventDefault());
            $('#send').click(() => send());
            await getChats(0);
            goToRecent();
        })

        function connect() {
            let socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, () => {

                stompClient.subscribe(`/room/${roomId}`, chat => show(chat));

            });
        }

        function send() {
            if ($('#content').val()) {
                stompClient.send(`/send/${roomId}`, {}, $('#content').val());
            }
            $('#content').val('');
        }

        function goToRecent() {
            const chatContainer = $('#chats');
            chatContainer.scrollTop(chatContainer.prop('scrollHeight'));
        }

        function show(chat) {
            console.log(chat);
            let parsed = JSON.parse(chat.body);
            $('#chats').append(chatBubble(parsed));
            goToRecent();
        }

        async function getMoreChats() {
            if (!curSlice.last) {
                const chatContainer = $('#chats');
                const oldScrollHeight = chatContainer.prop('scrollHeight');

                await getChats(curSlice.pageable.pageNumber + 1);

                const newScrollHeight = chatContainer.prop('scrollHeight');
                chatContainer.scrollTop(chatContainer.scrollTop() + newScrollHeight - oldScrollHeight);
            }
        }

        function chatBubble(chat) {
            return `
                    <div id="${chat.id}" class="chat chat-${chat.memberId == memberId ? "end" : "start"}">
                        <div class="chat-image avatar">
                                <div class="w-10 rounded-full">
                                <img src="${chat.profile}" />
                            </div>
                        </div>
                        <div class="chat-header">
                            ${chat.writer}
                            <time class="text-xs opacity-50">${dateFns.format(new Date(chat.createDate), 'YYYY-MM-DD HH:mm')}</time>
                        </div>
                        <div class="chat-bubble">${chat.content}</div>
                    </div>
                    `;
        }

        async function getChats(page) {
            $('#chats button:first').remove();
            await $.ajax({
                url: `/chats?roomId=${roomId}`,
                type: 'GET',
                data: {
                    page: page
                },
                success: function (slice) {
                    curSlice = slice;
                    slice.content.forEach(chat => $('#chats').prepend(chatBubble(chat)));
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error(textStatus, errorThrown);
                }
            });
            $('#chats').prepend(`<button onclick="getMoreChats();">더 불러오기</button>`);
        }

    </script>
</main>

<footer layout:fragment="footer">
    <a th:href="@{|/room/${room.id}/date|}"><i class="far fa-thin fa-clock text-slate-300 hover:text-sky-600"></i></a>
    <a th:href="@{|/room/${room.id}/place|}"><i
            class="far fa-solid fa-location-dot text-slate-300 hover:text-sky-600"></i></a>
    <a href=""><i class="far fa-thin fa-comments text-sky-600"></i></a>
</footer>
</body>

</html>