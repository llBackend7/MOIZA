<html layout:decorate="~{layout/layout.html}" xmlns:layout="http://www.w3.org/1999/xhtml">

<body>

<header layout:fragment="header" class="sticky top-0">
    <div class="navbar max-w-2xl mx-auto bg-base-100">
        <div class="navbar-start">
            <button onclick="location.href='/groups'">
                <i class="fas fa-thin fa-arrow-left fa-2xl ml-1"></i>
            </button>
        </div>
        <div class="navbar-center">
            <i class="fa-solid fa-location-dot fa-2xl" style="color: #1960ef;"></i>
            <span class="ml-2 text-xl">
          모임 참여
        </span>
        </div>
        <div class="navbar-end">
        </div>
    </div>
</header>

<main layout:fragment="main" class="flex-grow flex items-center justify-center">
    <div class="max-w-2xl w-full bg-blue-50">
        <div class="m-10 w-2xl flex flex-col items-center">
            <div class="w-full flex">
                <span class="title w-1/5">모임 이름</span>
                <span class="content w-3/5 text-center text-2xl font-gsans" th:text="${room.name}">서울 벙개</span>
            </div>

            <div class="w-full mt-4">
                <div class="h-40 flex flex-col items-center justify-center p-5 border border-none rounded-lg bg-white">
                    <div>
                        가능한 날짜는
                        <span class="p-1 text-xl border border-none rounded-lg bg-slate-200" th:text="${room.availableStartDay}"></span>
                        부터
                        <span class="p-1 text-xl border border-none rounded-lg bg-slate-200" th:text="${room.availableEndDay}"></span>
                        까지
                    </div>

                    <div class="mt-2">
                        가능한 시간은
                        <span class="p-1 text-xl border border-none rounded-lg bg-slate-200" th:text="${room.availableStartTime}"></span>
                        부터
                        <span class="p-1 text-xl border border-none rounded-lg bg-slate-200" th:text="${room.availableEndTime}"></span>
                        사이에 가능합니다.
                    </div>

                    <div class="mt-2">
                        약속 시간은
                        <span th:text="${#temporals.format(room.meetingDuration, 'h시간')}" class="p-1 text-xl border border-none rounded-lg bg-slate-200"></span>
                        입니다. 시간 범위에 맞게 지정해주세요.
                    </div>
                </div>
            </div>

            <div class="w-full mt-5">
                <span class="title">가능한 시간 선택</span>

                <!-- 가능시간 목록 -->
                <div class="shrink-0 border border-blue-400 rounded-lg divide-y divide-[#adcfee]"
                     id="availableTimeList"></div>
                <div class="text-end mr-4">
                    <button class="text-slate-400 mr-3" onclick="addNewTime();">+ 추가</button>
                    <button class="text-slate-400" onclick="removeNewTime();">- 삭제</button>
                </div>
            </div>

            <div class="text-center">
                <button class="room-btn mt-10" onclick="enter();">선택완료</button>
            </div>

        </div>
    </div>
    <script>
        function addNewTime() {
            $('#availableTimeList').append(`
            <div name="availableTime" class="flex gap-1 p-2">
                <div class="w-1/2 flex justify-center gap-2">
                    <span class="self-center text-center w-1/4 border border-none rounded-lg bg-slate-200 p-1" style="font-family: GmarketSansMedium !important;">날짜</span>
                    <input required name="date" type="date" class="input input-bordered flex items-center self-center w-4/6">
                </div>

                <div class="w-1/2 flex flex-col justify-center items-stretch gap-1">
                    <div class="w-2/2 flex justify-end mb-2 gap-1">
                        <span class="self-center border border-none rounded-lg bg-slate-200 p-1" style="font-family: GmarketSansMedium !important;">시작 시간</span>
                        <select required class="select select-bordered select-sm time-30m-intervals text-center font-gsans w-4/6" name="startTime"></select>
                    </div>

                    <div class="w-2/2 flex justify-end gap-1">
                      <span class="self-center border border-none rounded-lg bg-slate-200 p-1" style="font-family: GmarketSansMedium !important; ">끝나는 시간</span>
                      <select required class="select select-bordered select-sm time-30m-intervals text-center font-gsans w-4/6" name="endTime"></select>
                    </div>
                </div>
            </div>
            `);
                setTimeSelect();
            }

            function removeNewTime() {
                $('#availableTimeList').children().last().remove();
            }

            function checkRedundantTime(availableTimes) {
            let dateTimeMap = new Map();
            availableTimes.forEach(time => {
                if (dateTimeMap.has(time.date)) {
                    dateTimeMap.get(time.date).push({start:time.startTime, end: time.endTime});
                } else {
                    dateTimeMap.set(time.date, [{start:time.startTime, end: time.endTime}]);
                }
            });

            for (let [date, schedule] of dateTimeMap.entries()) {
                schedule.sort((a, b) => a.startTime - b.startTime);

                for (let i = 0; i < schedule.length - 1; i++) {
                    if (schedule[i].end === schedule[i + 1].start) {
                        toastWarning(`날짜 ${date} 일정 중 끝나는 시간과 시작하는 시간이 겹칩니다.`);
                        return true;
                    }
                    if (schedule[i].end > schedule[i + 1].start) {
                        toastWarning(`날짜 ${date}에 일정이 겹칩니다.`);
                        return true;
                    }
                }
            }
        }

        function enter() {
            let availableTimes = [];
            $('div[name=availableTime]').each(function () {
                const date = $(this).find('[name=date]').val();
                const startTime = $(this).find('[name=startTime]').val();
                const endTime = $(this).find('[name=endTime]').val();

                availableTimes.push({
                    date: date,
                    startTime: startTime,
                    endTime: endTime
                });
            });

            if (checkRedundantTime(availableTimes)) {
                return;
            }
            /*<![CDATA[*/
            const csrfToken = `[[${_csrf.token}]]`;
            const csrfHeader = `[[${_csrf.headerName}]]`;
            /*]]>*/

            $.ajax({
                url: window.location.href,
                type: 'post',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                contentType: 'application/json',
                data: JSON.stringify(availableTimes),
                success: function (response) {
                    console.log(response);
                    window.location.href = response.redirectUrl;
                },
                error: function (error) {
                    console.log(error);
                    toastWarning(error.responseJSON.message);
                }
            });
        }

        function setTimeSelect() {
            for (var i = 0; i < 24; i++) {
                for (var j = 0; j <= 30; j += 30) {
                    var hour = i < 10 ? '0' + i : i;
                    var minute = j < 10 ? '0' + j : j;
                    $('.time-30m-intervals').append(new Option(hour + ':' + minute, hour + ':' + minute));
                }
            }
        }

        toastr.options = {
            closeButton: true,
            debug: false,
            newestOnTop: true,
            progressBar: true,
            positionClass: "toast-top-right",
            preventDuplicates: false,
            onclick: null,
            showDuration: "300",
            hideDuration: "1000",
            timeOut: "5000",
            extendedTimeOut: "1000",
            showEasing: "swing",
            hideEasing: "linear",
            showMethod: "fadeIn",
            hideMethod: "fadeOut"
        };

        function parseMsg(msg) {
            const [pureMsg, ttl] = msg.split(";ttl=");

            const currentJsUnixTimestamp = new Date().getTime();

            if (ttl && parseInt(ttl) + 5000 < currentJsUnixTimestamp) {
                return [pureMsg, false];
            }

            return [pureMsg, true];
        }

        function toastWarning(msg) {
            const [pureMsg, needToShow] = parseMsg(msg);

            if (needToShow) {
                toastr["warning"](pureMsg, "경고");
            }
        }
    </script>
</main>
<footer layout:fragment="footer" class="hidden"></footer>
</body>
</html>